<script src="//code.jquery.com/jquery-2.2.0.js"></script>

<script>
$( function() {
    var qd = {};
    location.search.substr(1).split("&").forEach(function(item) {var s = item.split("="), k = s[0], v = s[1] &&
            decodeURIComponent(s[1]); (k in qd) ? qd[k].push(v) : qd[k] = [v]});
    console.log(qd);
    var params = {next: window.location.href};
    var token = null;
    if ( localStorage && localStorage.jwt ) {
        token = localStorage.jwt;
        console.log('got auth token <'+JSON.stringify(token)+'> from localStorage');
    }
    if ( !token || token === null || token.length < 5 ) {
        if ( qd.jwt && qd.jwt.length > 0 ) {
            token = qd.jwt[0];
            localStorage.jwt = token;
            console.log('got auth token '+token+' from params');
        } else {
            token = null;
        }
    }
    if ( token && token !== null ) {
        params.jwt = token;
    }
    params = $.param(params);
    console.log('authentication params are '+JSON.stringify(params));
    $.get('/oauth/check?'+params, function(data) {
        document.write('<pre>'+JSON.stringify(data)+'</pre>');
        if ( data.authenticated ) {
            document.write('<div>Authenticated!</div>');
            document.write('<div>Checking permissions...</div>');
            var params = {
                jwt: token,
                service: 'sample'
            };
            params = $.param(params);
            $.get('/permit/check?'+params, function(data) {
                document.write('<pre>'+JSON.stringify(data)+'</pre>');
                console.log('permission token is '+data.token);
                document.write('<div>Trying to use permission token with sample service...</div>');
                var params = {
                    jwt: data.token
                };
                params = $.param(params);
                $.post('/permit/sample?'+params, function(data) {
                    document.write('<div>Service got these verified permissions:</div>');
                    document.write('<pre>'+JSON.stringify(data)+'</pre>');
                }, 'json');
            }, 'json');
        } else {
            localStorage.jwt = null;
            document.write('<div>Redirecting to google in 10 sec</div>');
            window.setTimeout(function() {
                window.location = data.providers.google.url;
            },10000);
        }
    },'json');

});

</script>
